%%===========================================================
%%  Package: xememoir.sty
%%  Version: v3.0 (Refactor Branch)
%%  Date: 2025-11-01
%%  Author: Valery
%%-----------------------------------------------------------
%%  Description:
%%      –û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å –¥–ª—è –∫–ª–∞—Å—Å–∞ `memoir`, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
%%      –ø–æ–¥ XeLaTeX. –°–æ–¥–µ—Ä–∂–∏—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–µ –º–∞–∫—Ä–æ—Å—ã, —Ñ–ª–∞–≥–∏ –∏
%%      –≤—ã–∑–æ–≤—ã –º–æ–¥—É–ª–µ–π –ø–∞–∫–µ—Ç–∞ mysetup.sty.
%%
%%  Encoding: UTF-8
%%  Engine:   XeLaTeX
%%  License:  MIT
%%-----------------------------------------------------------
%%  Change Log:
%%      v3.0 - –ü–æ–ª–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ xememoir:
%%             * –ü–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ Valery
%%             * –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
%%             * –¥–æ–±–∞–≤–ª–µ–Ω—ã NOTE/TODO/FIX –º–µ—Ç–∫–∏
%%             * —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–ª–æ–∫–æ–≤
%%             * –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ kvoptions
%%===========================================================

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{xememoir}[2025/11/01 v3.0 Refactored memoir setup for XeLaTeX]

% ======================================================================
% üéõÔ∏è  –û–ë–†–ê–ë–û–¢–ö–ê –ë–ê–ó–û–í–´–• –û–ü–¶–ò–ô –ü–ê–ö–ï–¢–ê
% ======================================================================
% NOTE: –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–æ–π.
% TODO: –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ kvoptions –¥–ª—è —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ key=value
\newif\if@xem@ms
\newif\if@xem@liberation
\newif\if@xem@cmu

% –¢–∏–ø–æ–≥—Ä–∞—Ñ—Å–∫–∏–µ –ø—Ä–æ—Ñ–∏–ª–∏
\newif\if@xem@classic
\newif\if@xem@modern
\newif\if@xem@academic
\newif\if@xem@poetry
\newif\if@xem@technical
\newif\if@xem@elegant
\newif\if@xem@compact
\newif\if@xem@bold

% –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ—Ñ–∏–ª–∏
\newif\if@xemg@classic
\newif\if@xemg@colorful
\newif\if@xemg@minimal
\newif\if@xemg@technical
\newif\if@xemg@presentation

% –°—Ç–∏–ª–∏ —Å–ø–∏—Å–∫–æ–≤
\newif\if@xeml@gost
\newif\if@xeml@numeric
\newif\if@xeml@mixed
\newif\if@xeml@alpha

% –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
\@xem@mstrue
\@xem@classictrue
\@xemg@classictrue
\@xeml@gosttrue

% ======================================================================
% üîí  –ó–ê–©–ò–¢–ê –û–¢ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø –ù–ï –° MEMOIR
% ======================================================================
\@ifclassloaded{memoir}{}{
  \PackageError{xememoir}{This package requires the 'memoir' document class.}
  {Use \string\documentclass\{memoir\} in your main .tex file.}
}

% ======================================================================
% üì¶  –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –°–õ–£–ñ–ï–ë–ù–´–ï –ü–ê–ö–ï–¢–´
% ======================================================================
\RequirePackage{etoolbox}  % —É—Å–ª–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–∞–º–∏
\RequirePackage{fontspec}  % —Å–∏—Å—Ç–µ–º–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã
\PassOptionsToPackage{table,xcdraw}{xcolor}
\RequirePackage{xcolor}    % —Ü–≤–µ—Ç–∞
\RequirePackage{microtype} % –º–∏–∫—Ä–æ—Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞

% ======================================================================
% üß©  –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ú–û–î–£–õ–ï–ô (–Ω–æ–≤–∞—è –º–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
% ======================================================================
% NOTE: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏–∑ —Ç–≤–æ–∏—Ö –º–æ–¥—É–ª–µ–π
% TODO: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –º–æ–¥—É–ª–∏ –≤ –Ω–æ–≤—ã–µ, —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ

% 1Ô∏è‚É£ –®—Ä–∏—Ñ—Ç—ã
\InputIfFileExists{xememoir-fonts.sty}{}{%
  \typeout{Package xememoir: xememoir-fonts.sty not found, using fontswitch.sty as fallback.}
  \InputIfFileExists{fontswitch.sty}{}{%
    \typeout{Package xememoir: fontswitch.sty not found, using fontspec defaults.}
  }
}

% 2Ô∏è‚É£ Layout (–ø–æ–ª—è, –∫–æ–ª–æ–Ω—Ç–∏—Ç—É–ª—ã)
\InputIfFileExists{xememoir-layout.sty}{}{%
  \typeout{Package xememoir: xememoir-layout.sty not found, using layoutsetup.sty as fallback.}
  \InputIfFileExists{layoutsetup.sty}{}{%
    \typeout{Package xememoir: layoutsetup.sty not found, using memoir defaults.}
  }
}

% 3Ô∏è‚É£ Graphics (–≥—Ä–∞—Ñ–∏–∫–∞ –∏ –ø—Ä–æ—Ñ–∏–ª–∏)
\InputIfFileExists{xememoir-graphics.sty}{}{%
  \typeout{Package xememoir: xememoir-graphics.sty not found, using graphicssetup.sty as fallback.}
  \InputIfFileExists{graphicssetup.sty}{}{%
    \typeout{Package xememoir: graphicssetup.sty not found, using defaults.}
  }
}

% 4Ô∏è‚É£ Lists (—Å—Ç–∏–ª–∏ —Å–ø–∏—Å–∫–æ–≤)
\InputIfFileExists{xememoir-lists.sty}{}{%
  \typeout{Package xememoir: xememoir-lists.sty not found, using enumsetup.sty as fallback.}
  \InputIfFileExists{enumsetup.sty}{}{%
    \typeout{Package xememoir: enumsetup.sty not found, using defaults.}
  }
}

% 5Ô∏è‚É£ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏ (math, tables, bib, todo, listings, pdf)
\InputIfFileExists{xememoir-modules.sty}{}{%
  \typeout{Package xememoir: xememoir-modules.sty not found, using old modules as fallback.}
  \InputIfFileExists{mathsetup.sty}{}{%
    \typeout{Package xememoir: mathsetup.sty not found, using defaults.}
  }
  \InputIfFileExists{tablesetup.sty}{}{%
    \typeout{Package xememoir: tablesetup.sty not found, using defaults.}
  }
  \InputIfFileExists{bibsetup.sty}{}{%
    \typeout{Package xememoir: bibsetup.sty not found, using defaults.}
  }
  \InputIfFileExists{todo-setup.sty}{}{%
    \typeout{Package xememoir: todo-setup.sty not found, using defaults.}
  }
  \InputIfFileExists{listingssetup.tex}{}{%
    \typeout{Package xememoir: listingssetup.tex not found, using defaults.}
  }
  \InputIfFileExists{pdf-setup.sty}{}{%
    \typeout{Package xememoir: pdf-setup.sty not found, using defaults.}
  }
}

% ======================================================================
% üîó  Hyperref (–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏–º)
% ======================================================================
\IfFileExists{hyperref.sty}{%
  \PassOptionsToPackage{unicode}{hyperref}%
  \RequirePackage{hyperref}%
  \hypersetup{%
    colorlinks=true,
    linkcolor=blue,
    citecolor=blue,
    urlcolor=blue,
    bookmarksnumbered=true,
    bookmarksopen=true,
    bookmarksopenlevel=1
  }%
}{}

% ======================================================================
% üìù  DIAGNOST–ò–ö–ê –ê–ö–¢–ò–í–ù–´–• –§–õ–ê–ì–û–í
% ======================================================================
\AtEndOfPackage{%
  \typeout{[xememoir] Active font flags: ms=\if@xem@ms, liberation=\if@xem@liberation, cmu=\if@xem@cmu}%
  \typeout{[xememoir] Active bookstyle flags: classic=\if@xem@classic, modern=\if@xem@modern, academic=\if@xem@academic, poetry=\if@xem@poetry, technical=\if@xem@technical, elegant=\if@xem@elegant, compact=\if@xem@compact, bold=\if@xem@bold}%
  \typeout{[xememoir] Active graphicstyle flags: classic=\if@xemg@classic, colorful=\if@xemg@colorful, minimal=\if@xemg@minimal, technical=\if@xemg@technical, presentation=\if@xemg@presentation}%
  \typeout{[xememoir] Active liststyle flags: gost=\if@xeml@gost, numeric=\if@xeml@numeric, mixed=\if@xeml@mixed, alpha=\if@xeml@alpha}%
}

\endinput
