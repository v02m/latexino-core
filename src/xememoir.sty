%%===========================================================
%%  Package: xememoir.sty –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –ø–∞–∫–µ—Ç–∞
%%  Version: v3.0 (Refactor Branch)
%%  –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: XeLaTeX, LuaLaTeX, –∫–ª–∞—Å—Å memoir
%%  –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥: 2025-11-01
%%  Author: Valery
%%-----------------------------------------------------------
%%  Description:
%%      –û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å –¥–ª—è –∫–ª–∞—Å—Å–∞ `memoir`, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
%%      –ø–æ–¥ XeLaTeX. –°–æ–¥–µ—Ä–∂–∏—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–µ –º–∞–∫—Ä–æ—Å—ã, —Ñ–ª–∞–≥–∏ –∏
%%      –≤—ã–∑–æ–≤—ã –º–æ–¥—É–ª–µ–π –ø–∞–∫–µ—Ç–∞ xememoir.sty.
%%      –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ—à–∞–≥–æ–≤–æ–≥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞.
%%      –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å —Å—Ç–∞—Ä—É—é/–Ω–æ–≤—É—é –ª–æ–≥–∏–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –º–æ–¥—É–ª–µ–π.
%%
%%  Encoding: UTF-8
%%  Engine:   XeLaTeX
%%  License:  MIT
%%-----------------------------------------------------------
%%  Change Log:
%%      v3.0 - –ü–æ–ª–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ xememoir:
%%             * –ü–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ Valery
%%             * –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
%%             * –¥–æ–±–∞–≤–ª–µ–Ω—ã NOTE/TODO/FIX –º–µ—Ç–∫–∏
%%             * —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–ª–æ–∫–æ–≤
%%             * –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ kvoptions
%%===========================================================

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{xememoir}[2025/11/01 v3.0 Refactored memoir setup for XeLaTeX]

% ======================================================================
% üéõÔ∏è  –í–´–ë–û–† –†–ï–ñ–ò–ú–ê: –°–¢–ê–†–´–ô/–ù–û–í–´–ô
% ======================================================================
\newif\ifxememoir@usenew
\xememoir@usenewtrue   % –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –Ω–∞ –Ω–æ–≤—É—é –º–æ–¥—É–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
% \xememoir@usenewfalse  % –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ä–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

% ======================================================================
% üîí  –ü—Ä–æ–≤–µ—Ä–∫–∞ memoir
% ======================================================================
\@ifclassloaded{memoir}{}{
  \PackageError{xememoir}{This package requires the 'memoir' document class.}
  {Use \string\documentclass\{memoir\} in your main .tex file.}
}

% ======================================================================
% üì¶  –ë–ê–ó–û–í–´–ï –ü–ê–ö–ï–¢–´
% ======================================================================
\RequirePackage{etoolbox}
\RequirePackage{fontspec}
\PassOptionsToPackage{table,xcdraw}{xcolor}
\RequirePackage{xcolor}
\RequirePackage{microtype}

% ======================================================================
% üß©  –û–ë–©–ò–ï –§–õ–ê–ì–ò –ü–ê–ö–ï–¢–ê xememoir
% ======================================================================
% NOTE: –ü–æ–∫–∞ —Ä—É—á–Ω—ã–µ —Ñ–ª–∞–≥–∏, –ø–æ–∑–∂–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ kvoptions
% –§–ª–∞–≥–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ —à—Ä–∏—Ñ—Ç–æ–≤
\newif\if@xem@ms
\newif\if@xem@liberation
\newif\if@xem@cmu

% –§–ª–∞–≥–∏ –¥–ª—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π –∫–Ω–∏–≥–∏
\newif\if@xem@classic
\newif\if@xem@modern
\newif\if@xem@academic
\newif\if@xem@poetry
\newif\if@xem@technical
\newif\if@xem@elegant
\newif\if@xem@compact
\newif\if@xem@bold

% –§–ª–∞–≥–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π
\newif\if@xemg@classic
\newif\if@xemg@colorful
\newif\if@xemg@minimal
\newif\if@xemg@technical
\newif\if@xemg@presentation

% –§–ª–∞–≥–∏ –¥–ª—è —Å—Ç–∏–ª–µ–π —Å–ø–∏—Å–∫–æ–≤
\newif\if@xeml@gost
\newif\if@xeml@numeric
\newif\if@xeml@mixed
\newif\if@xeml@alpha

% ======================================================================
% üîó  –ê–ª–∏–∞—Å—ã –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –∏–º–µ–Ω (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
% ======================================================================
% Bookstyle aliases
\let\ifbookstyle@classic=\if@xem@classic
\let\ifbookstyle@modern=\if@xem@modern
\let\ifbookstyle@academic=\if@xem@academic
\let\ifbookstyle@poetry=\if@xem@poetry
\let\ifbookstyle@technical=\if@xem@technical
\let\ifbookstyle@elegant=\if@xem@elegant
\let\ifbookstyle@compact=\if@xem@compact
\let\ifbookstyle@bold=\if@xem@bold

% Liststyle aliases
\let\ifliststyle@gost=\if@xeml@gost
\let\ifliststyle@numeric=\if@xeml@numeric
\let\ifliststyle@mixed=\if@xeml@mixed
\let\ifliststyle@alpha=\if@xeml@alpha

% Font selection aliases
\let\ifusemsfonts=\if@xem@ms
\let\ifuseliberationfonts=\if@xem@liberation
\let\ifusecmufonts=\if@xem@cmu

% Graphic style aliases
\let\ifgraphicstyle@classic=\if@xemg@classic
\let\ifgraphicstyle@colorful=\if@xemg@colorful
\let\ifgraphicstyle@minimal=\if@xemg@minimal
\let\ifgraphicstyle@technical=\if@xemg@technical
\let\ifgraphicstyle@presentation=\if@xemg@presentation

% ======================================================================
% ‚öôÔ∏è  –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–º–æ–∂–Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è —Ç–µ—Å—Ç–∞)
% ======================================================================
%\@xem@mstrue       % –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º Microsoft fonts
%\@xem@classictrue  % —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è
%\@xemg@classictrue % –≥—Ä–∞—Ñ–∏–∫–∞ ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è
%\@xeml@gosttrue    % —Å–ø–∏—Å–∫–∏ ‚Äî –ì–û–°–¢

% üîπ –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:
% –ï—Å–ª–∏ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ñ–ª–∞–≥–∏, –≤–∫–ª—é—á–∏—Ç—Å—è fallback:
% - –®—Ä–∏—Ñ—Ç—ã CMU
% - –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ classic
% - –ì—Ä–∞—Ñ–∏–∫–∞ classic
% - –°–ø–∏—Å–∫–∏ –ì–û–°–¢

% ======================================================================
% üß©  –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ú–û–î–£–õ–ï–ô –ü–û –†–ï–ñ–ò–ú–£
% ======================================================================
\ifxememoir@usenew
% ‚úÖ –ù–æ–≤–∞—è –º–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

% --- 1Ô∏è‚É£ –®—Ä–∏—Ñ—Ç—ã
\InputIfFileExists{xememoir-fonts.sty}{}{%
  \typeout{[xememoir] xememoir-fonts.sty not found, fallback to fontswitch.sty.}%
  \InputIfFileExists{fontswitch.sty}{}{%
    \typeout{[xememoir] fontswitch.sty not found, using fontspec defaults.}%
  }%
}

% --- 2Ô∏è‚É£ Layout (–ø–æ–ª—è, –∫–æ–ª–æ–Ω—Ç–∏—Ç—É–ª—ã)
\InputIfFileExists{xememoir-layout.sty}{}{%
  \typeout{[xememoir] xememoir-layout.sty not found, fallback to layoutsetup.sty.}%
  \InputIfFileExists{layoutsetup.sty}{}{%
    \typeout{[xememoir] layoutsetup.sty not found, using memoir defaults.}%
  }%
}

% --- 3Ô∏è‚É£ Graphics (–≥—Ä–∞—Ñ–∏–∫–∞ –∏ –ø—Ä–æ—Ñ–∏–ª–∏)
\InputIfFileExists{xememoir-graphics.sty}{}{%
  \typeout{[xememoir] xememoir-graphics.sty not found, fallback to graphicssetup.sty.}%
  \InputIfFileExists{graphicssetup.sty}{}{%
    \typeout{[xememoir] graphicssetup.sty not found, using defaults.}%
  }%
}

% --- 4Ô∏è‚É£ Lists (—Å—Ç–∏–ª–∏ —Å–ø–∏—Å–∫–æ–≤)
\InputIfFileExists{xememoir-lists.sty}{}{%
  \typeout{[xememoir] xememoir-lists.sty not found, fallback to enumsetup.sty.}%
  \InputIfFileExists{enumsetup.sty}{}{%
    \typeout{[xememoir] enumsetup.sty not found, using defaults.}%
  }%
}

% --- 5Ô∏è‚É£ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏ (math, tables, bib, todo, listings, pdf)
\InputIfFileExists{xememoir-modules.sty}{}{%
  \typeout{[xememoir] xememoir-modules.sty not found, fallback to old modules.}%
  \InputIfFileExists{mathsetup.sty}{}{\typeout{[xememoir] mathsetup.sty not found, using defaults.}}%
  \InputIfFileExists{tablesetup.sty}{}{\typeout{[xememoir] tablesetup.sty not found, using defaults.}}%
  \InputIfFileExists{bibsetup.sty}{}{\typeout{[xememoir] bibsetup.sty not found, using defaults.}}%
  \InputIfFileExists{todo-setup.sty}{}{\typeout{[xememoir] todo-setup.sty not found, using defaults.}}%
  \InputIfFileExists{listingssetup.tex}{}{\typeout{[xememoir] listingssetup.tex not found, using defaults.}}%
  \InputIfFileExists{pdf-setup.sty}{}{\typeout{[xememoir] pdf-setup.sty not found, using defaults.}}%
}

\else
% ‚ö†Ô∏è –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
\typeout{[xememoir] Using old module loading logic.}%
% –ó–¥–µ—Å—å –≤—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ include/require –±–ª–æ–∫–∏, —á—Ç–æ–±—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
\fi

% ======================================================================
% üîó  Hyperref (–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏–º)
% ======================================================================
\IfFileExists{hyperref.sty}{%
  \PassOptionsToPackage{unicode}{hyperref}%
  \RequirePackage{hyperref}%
  \hypersetup{%
    colorlinks=true,
    linkcolor=blue,
    citecolor=blue,
    urlcolor=blue,
    bookmarksnumbered=true,
    bookmarksopen=true,
    bookmarksopenlevel=1
  }%
}{}

% ======================================================================
% üìù  DIAGNOST–ò–ö–ê –ê–ö–¢–ò–í–ù–´–• –§–õ–ê–ì–û–í
% ======================================================================
\AtEndOfPackage{%
  \typeout{[xememoir] Active font flags: ms=\if@xem@ms, liberation=\if@xem@liberation, cmu=\if@xem@cmu}%
  \typeout{[xememoir] Active bookstyle flags: classic=\if@xem@classic, modern=\if@xem@modern, academic=\if@xem@academic, poetry=\if@xem@poetry, technical=\if@xem@technical, elegant=\if@xem@elegant, compact=\if@xem@compact, bold=\if@xem@bold}%
  \typeout{[xememoir] Active graphicstyle flags: classic=\if@xemg@classic, colorful=\if@xemg@colorful, minimal=\if@xemg@minimal, technical=\if@xemg@technical, presentation=\if@xemg@presentation}%
  \typeout{[xememoir] Active liststyle flags: gost=\if@xeml@gost, numeric=\if@xeml@numeric, mixed=\if@xeml@mixed, alpha=\if@xeml@alpha}%
}

\endinput
